{% extends 'base.html' %}

{% block title %}{{ post.title }} - ì„œë¡œì†Œì‹ ë¸”ë¡œê·¸{% endblock %}

{% block meta_description %}{% if post.meta_description %}{{ post.meta_description }}{% else %}{{ post.content|truncatewords:30|striptags }}{% endif %}{% endblock %}

{% block og_type %}article{% endblock %}
{% block og_title %}{{ post.title }}{% endblock %}
{% block og_description %}{% if post.meta_description %}{{ post.meta_description }}{% else %}{{ post.content|truncatewords:30|striptags }}{% endif %}{% endblock %}

{% block twitter_title %}{{ post.title }}{% endblock %}
{% block twitter_description %}{% if post.meta_description %}{{ post.meta_description }}{% else %}{{ post.content|truncatewords:30|striptags }}{% endif %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Post Header -->
        <article class="card mb-4">
            <div class="card-body p-4">
                <!-- Meta Info -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        {% if post.category %}
                        <a href="{% url 'category_posts' post.category.slug %}"
                            class="badge bg-success text-decoration-none me-2">
                            <i class="bi bi-folder"></i> {{ post.category.name }}
                        </a>
                        {% endif %}
                        <span class="badge bg-primary me-2">{{ post.author.username }}</span>
                        {% if not post.is_public %}
                        <span class="badge bg-warning text-dark">
                            <i class="bi bi-lock me-1"></i>ë¹„ê³µê°œ
                        </span>
                        {% endif %}
                    </div>
                    <small class="text-secondary">
                        <i class="bi bi-eye me-1"></i>{{ post.views }}
                        <i class="bi bi-calendar3 ms-2 me-1"></i>{{ post.created_at|date:"Yë…„ mì›” dì¼ H:i" }}
                        {% if post.updated_at != post.created_at %}
                        <span class="ms-2">
                            <i class="bi bi-pencil me-1"></i>{{ post.updated_at|date:"Y.m.d H:i" }} ìˆ˜ì •ë¨
                        </span>
                        {% endif %}
                    </small>
                </div>

                <!-- Title -->
                <h1 class="display-6 fw-bold mb-4 text-white">{{ post.title }}</h1>

                <!-- Content -->
                <div class="post-content text-white" id="post-content" style="line-height: 1.8; color: #e0e0e0;">
                    <!-- ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ëŒ€ì‹  ì¼ë°˜ í…ìŠ¤íŠ¸ í´ë°± -->
                    <noscript>{{ post.content|linebreaks }}</noscript>
                </div>
                
                <script>
                    // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§
                    document.addEventListener('DOMContentLoaded', function() {
                        const rawContent = `{{ post.content|escapejs }}`;
                        const postContent = document.getElementById('post-content');
                        
                        if (typeof marked !== 'undefined') {
                            // marked.js ì„¤ì •
                            marked.setOptions({
                                breaks: true,
                                gfm: true
                            });
                            
                            postContent.innerHTML = marked.parse(rawContent);
                            
                            // Prism ì¬ì ìš©
                            if (typeof Prism !== 'undefined') {
                                Prism.highlightAllUnder(postContent);
                            }
                        } else {
                            // marked ì—†ìœ¼ë©´ ê¸°ë³¸ ì¶œë ¥
                            postContent.innerHTML = rawContent.replace(/\n/g, '<br>');
                        }
                    });
                </script>

                <!-- Tags -->
                {% if post.tags.exists %}
                <div class="mt-4">
                    {% for tag in post.tags.all %}
                    <a href="{% url 'tag_posts' tag.slug %}" class="badge bg-secondary text-decoration-none me-1">
                        #{{ tag.name }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Actions -->
                {% if user == post.author %}
                <hr class="my-4" style="border-color: var(--border-color);">
                <div class="d-flex gap-2">
                    <a href="{% url 'post_update' post.pk %}" class="btn btn-outline-primary">
                        <i class="bi bi-pencil me-1"></i>ìˆ˜ì •
                    </a>
                    <a href="{% url 'post_delete' post.pk %}" class="btn btn-outline-danger">
                        <i class="bi bi-trash me-1"></i>ì‚­ì œ
                    </a>
                </div>
                {% endif %}
            </div>
        </article>

        <!-- Related Posts -->
        {% if related_posts %}
        <div class="card mb-4">
            <div class="card-body p-4">
                <h5 class="mb-4">
                    <i class="bi bi-link-45deg me-2"></i>ê´€ë ¨ ê¸€
                </h5>
                <div class="row g-3">
                    {% for related in related_posts %}
                    <div class="col-md-6 col-lg-4">
                        <a href="{{ related.get_absolute_url }}" class="text-decoration-none">
                            <div class="p-3 rounded" style="background: var(--bg-dark); border: 1px solid var(--border-color); transition: all 0.3s ease;"
                                onmouseover="this.style.borderColor='var(--primary-color)'" 
                                onmouseout="this.style.borderColor='var(--border-color)'">
                                {% if related.category %}
                                <span class="badge bg-success mb-2">{{ related.category.name }}</span>
                                {% endif %}
                                <h6 class="text-white mb-2" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    {{ related.title }}
                                </h6>
                                <small class="text-secondary">
                                    <i class="bi bi-eye me-1"></i>{{ related.views }}
                                    <i class="bi bi-calendar3 ms-2 me-1"></i>{{ related.created_at|date:"Y.m.d" }}
                                </small>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Comments Section -->
        <div class="card">
            <div class="card-body p-4">
                <h5 class="mb-4">
                    <i class="bi bi-chat-dots me-2"></i>ëŒ“ê¸€ ({{ comments.count }})
                </h5>

                <!-- Comment Form -->
                {% if can_comment %}
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'comment_create' post.pk %}" class="mb-4">
                        {% csrf_token %}
                        <div class="mb-3">
                            {{ comment_form.content }}
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send me-1"></i>ëŒ“ê¸€ ì‘ì„±
                        </button>
                    </form>
                    {% else %}
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="{% url 'login' %}">ë¡œê·¸ì¸</a>í•´ì£¼ì„¸ìš”.
                    </div>
                    {% endif %}
                {% else %}
                <div class="alert alert-secondary mb-4">
                    <i class="bi bi-lock me-2"></i>
                    ë°œí–‰ëœ ê¸€ì—ë§Œ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
                {% endif %}

                <!-- Comments List -->
                {% for comment in comments %}
                <div class="border-bottom pb-3 mb-3" style="border-color: var(--border-color) !important;">
                    {% if comment.is_hidden %}
                    <!-- ìˆ¨ê²¨ì§„ ëŒ“ê¸€ -->
                    <div class="text-secondary">
                        <i class="bi bi-eye-slash me-1"></i>
                        <em>ìˆ¨ê²¨ì§„ ëŒ“ê¸€ì…ë‹ˆë‹¤.</em>
                        {% if user.is_staff %}
                        <span class="ms-2">
                            (ì‹ ê³  {{ comment.report_count }}íšŒ)
                            <a href="{% url 'comment_hide' post.pk comment.pk %}" class="btn btn-sm btn-outline-success ms-2">
                                <i class="bi bi-eye me-1"></i>í‘œì‹œ
                            </a>
                        </span>
                        {% endif %}
                    </div>
                    {% else %}
                    <!-- ì¼ë°˜ ëŒ“ê¸€ í‘œì‹œ -->
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="badge bg-secondary">{{ comment.author.username }}</span>
                            <small class="text-secondary ms-2">{{ comment.created_at|date:"Y.m.d H:i" }}</small>
                            {% if comment.report_count > 0 and user.is_staff %}
                            <span class="badge bg-warning text-dark ms-2">
                                <i class="bi bi-flag me-1"></i>{{ comment.report_count }}
                            </span>
                            {% endif %}
                        </div>
                        <div>
                            <!-- ì‹ ê³  ë²„íŠ¼ (ë‹¤ë¥¸ ì‚¬ìš©ì ëŒ“ê¸€ë§Œ, ê´€ë¦¬ì ëŒ“ê¸€ ì œì™¸) -->
                            {% if user.is_authenticated and user != comment.author and not comment.author.is_staff %}
                            <button type="button" class="btn btn-sm btn-outline-warning" 
                                data-bs-toggle="modal" data-bs-target="#reportModal{{ comment.pk }}">
                                <i class="bi bi-flag"></i>
                            </button>
                            {% endif %}
                            
                            <!-- ì‚­ì œ ë²„íŠ¼ (ì‘ì„±ìë§Œ) -->
                            {% if user == comment.author %}
                            <form method="post" action="{% url 'comment_delete' post.pk comment.pk %}"
                                style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                            {% endif %}
                            
                            <!-- ìˆ¨ê¹€ ë²„íŠ¼ (ê´€ë¦¬ìë§Œ) -->
                            {% if user.is_staff %}
                            <a href="{% url 'comment_hide' post.pk comment.pk %}" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-eye-slash"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <p class="mt-2 mb-0">{{ comment.content|linebreaks }}</p>
                    
                    <!-- ì‹ ê³  ëª¨ë‹¬ -->
                    {% if user.is_authenticated and user != comment.author %}
                    <div class="modal fade" id="reportModal{{ comment.pk }}" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
                                <form method="post" action="{% url 'comment_report' post.pk comment.pk %}">
                                    {% csrf_token %}
                                    <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                                        <h5 class="modal-title">
                                            <i class="bi bi-flag-fill text-warning me-2"></i>ëŒ“ê¸€ ì‹ ê³ 
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label class="form-label">ì‹ ê³  ì‚¬ìœ </label>
                                            <select name="reason" class="form-select" 
                                                style="background-color: var(--bg-dark); border-color: var(--border-color); color: var(--text-primary);">
                                                <option value="spam">ğŸš« ìŠ¤íŒ¸/ê´‘ê³ </option>
                                                <option value="abuse">ğŸ¤¬ ìš•ì„¤/ë¹„ë°©</option>
                                                <option value="hate">ğŸ˜¡ í˜ì˜¤/ì°¨ë³„</option>
                                                <option value="illegal">âš ï¸ ë¶ˆë²• ì •ë³´</option>
                                                <option value="other">ğŸ“ ê¸°íƒ€</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">ìƒì„¸ ë‚´ìš© <small class="text-secondary">(ì„ íƒ)</small></label>
                                            <textarea name="detail" class="form-control" rows="3" 
                                                style="background-color: var(--bg-dark); border-color: var(--border-color); color: var(--text-primary);"
                                                placeholder="ì¶”ê°€ ì„¤ëª…ì´ ìˆìœ¼ë©´ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                                        <button type="submit" class="btn btn-danger">
                                            <i class="bi bi-exclamation-triangle me-1"></i>ì‹ ê³ í•˜ê¸°
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
                {% empty %}
                <p class="text-secondary text-center py-4">
                    <i class="bi bi-chat display-4 d-block mb-2"></i>
                    ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!
                </p>
                {% endfor %}
            </div>
        </div>

        <!-- Back Button -->
        <div class="mt-4">
            <a href="{% url 'post_list' %}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-1"></i>ëª©ë¡ìœ¼ë¡œ
            </a>
        </div>
    </div>
</div>
{% endblock %}